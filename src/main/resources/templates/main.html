<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="layout/css/custom-style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/cb31ad365a.js" crossorigin="anonymous"></script>
</head>
<body class="body">
<div class="sidenav">
    <img src="layout/srcs/logo.svg" alt="logo" class="logo"/>
    <a href="#" class="menu">HOME</a>
    <a href="#" class="menu">TOP 10</a>
    <a href="#" class="menu">관심 종목</a>
    <a href="#" class="menu">자산 관리</a>
    <div class="flex-container">
        <img src="layout/srcs/icons/user-logo.svg" alt="icon" class="flex-component"/>
        <!-- 사용자 이름을 표시하고, 클릭 시 로그아웃 -->
        <a id="userName" class="flex-component" href="javascript:void(0);" th:text="${#authentication.name}"
           onclick="logout()" th:if="${#authorization.expression('isAuthenticated()')}"></a>

        <!-- 비로그인 시 로그인 버튼 표시 -->
        <a class="flex-component" href="/login" th:unless="${#authorization.expression('isAuthenticated()')}">
            Login
        </a>
    </div>
</div>
    <div class="main-content">
        <div class="search-group">
            <i class="fa-solid fa-magnifying-glass fa-lg" style="color: #315784;"></i>
            <input type="text" class="search-control" placeholder="검색어를 입력하세요.">
        </div>
        <h5 class="title">국내 지수</h5>
        <div class="stats">        
            <div class="stat-box">
                <h6 class="stat-name">코스피</h6>
                <p class="stat-value">2,758.42</p>
                <p class="stat-change">▲ 3.53 (+0.13%)</p>
            </div>
            <div class="stat-box">
                <h6 class="stat-name">코스닥</h6>
                <p class="stat-value down-stat">862.19</p>
                <p class="stat-change down-stat">▼ 9.14 (-1.05%)</p>
            </div>
            <div class="stat-box">
                <h6 class="stat-name">코스피 200</h6>
                <p class="stat-value">376.00</p>
                <p class="stat-change">▲ 1.25 (+0.33%)</p>
            </div>
        </div>
        <h5 class="title">관심 종목</h5>
        <div class="section-group">
            <div class="left-section">
                <div class="section">
                    <h6>토글</h6>
                    <table class="stocks-table">
                        <thead>
                            <tr>
                                <th>종목명</th>
                                <th>현재가</th>
                                <th>등락률</th>
                                <th>시가총액</th>
                                <th>거래량/거래대금</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>삼성전자</td>
                                <td>79,600</td>
                                <td class="up">+1.27%</td>
                                <td>475조 1,947억원</td>
                                <td>22,801,339
                                    <br />
                                    <p class="additional-value">1조 8,023억원</p>
                                </td>
                            </tr>
                            <tr>
                                <td>에코프로비엠</td>
                                <td>200,500</td>
                                <td class="down">-4.07%</td>
                                <td>18조 4,500억원</td>
                                <td>8,723,000<br />
                                    <p class="additional-value">1조 2,003억원</p>
                                </td>
                            </tr>
                            <tr>
                                <td>현대차</td>
                                <td>268,000</td>
                                <td class="down">-0.37%</td>
                                <td>57조 2,000억원</td>
                                <td>5,200,000
                                    <br />
                                    <p class="additional-value">3,231억원</p>
                                </td>
                            </tr>
                            <tr>
                                <td>에코프로</td>
                                <td>99,400</td>
                                <td class="down">-1.58%</td>
                                <td>15조 9,000억원</td>
                                <td>4,200,000
                                    <br />
                                    <p class="additional-value">1,652억원</p>
                                </td>
                            </tr>
                            <tr>
                                <td>HLB</td>
                                <td>62,300</td>
                                <td class="down">-2.04%</td>
                                <td>5조 3,000억원</td>
                                <td>3,100,000
                                    <br />
                                    <p class="additional-value">925억원</p>
                                </td>
                            </tr>
                            <tr>
                                <td>알테오젠</td>
                                <td>265,000</td>
                                <td class="down">-1.30%</td>
                                <td>35조 2,000억원</td>
                                <td>1,500,000
                                    <br />
                                    <p class="additional-value">4,125억원</p>
                                </td>
                            </tr>
                            <tr>
                                <td>두산에너빌리티</td>
                                <td>19,660</td>
                                <td class="up">+0.72%</td>
                                <td>3조 1,000억원</td>
                                <td>1,200,000
                                    <br />
                                    <p class="additional-value">234억원</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="right-section">
                <div class="section assets-summary">
                    <div class="flex-text-group">
                        <p>총 자산</p>
                        <p class="total-asset">10,962,194 원</p>
                    </div>
                    <div class="flex-text-group">
                        <p>가용 자산</p>
                        <p class="available-asset">2,264,568 원</p>
                    </div>
                </div>
                <div class="section">
                    <h6>보유 종목</h6>
                    <table class="owned-stocks">
                        <thead>
                            <tr>
                                <th>종목명</th>
                                <th>현재가</th>
                                <th>등락률</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>삼성전자</td>
                                <td>79,600</td>
                                <td class="up">+1.27%</td>
                            </tr>
                            <tr>
                                <td>에코프로비엠</td>
                                <td>200,500</td>
                                <td class="down">-4.07%</td>
                            </tr>
                            <tr>
                                <td>현대차</td>
                                <td>268,000</td>
                                <td class="down">-0.37%</td>
                            </tr>
                            <tr>
                                <td>에코프로</td>
                                <td>99,400</td>
                                <td class="down">-1.58%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        let accessToken = getCookie("Authorization")
        console.log(accessToken);

        if(accessToken!=null){
            axios.get('/members/info', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                const memberInfo = response.data;
                document.getElementById('userName').textContent = memberInfo.name;
            })
            .catch(error => {
                console.error('Failed to fetch member info:', error);
                if (error.response && error.response.status === 401) {
                    alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                    window.location.href = '/login';
                } else {
                    alert('사용자 정보를 가져오는데 실패했습니다.');
                }
            });
        }
    });
    function logout() {
        axios.get('/auth/logout')
            .then(() => {
                window.location.href = '/login';
            })
            .catch(error => {
                console.error('Logout failed:', error);
                // 오류 발생 시 사용자에게 알림
                alert('로그아웃 중 오류가 발생했습니다. 다시 시도해 주세요.');
            });
    }
    function getCookie(cookieName) {
        let name = cookieName + "=";
        let decodedCookie = decodeURIComponent(document.cookie); // 쿠키 값이 인코딩되어 있을 수 있으므로 디코딩
        let cookieArray = decodedCookie.split(';'); // 각 쿠키는 세미콜론으로 구분됨

        for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i].trim(); // 공백 제거

            // 쿠키 이름으로 시작하는지 확인
            if (cookie.indexOf(name) === 0) {
                return cookie.substring(name.length, cookie.length); // 쿠키 값 반환
            }
        }
        return ""; // 해당 이름의 쿠키가 없으면 빈 문자열 반환
    }
</script>