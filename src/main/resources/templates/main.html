<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
  <head th:replace="~{common/header :: header}"></head>
  <body class="body">
    <div th:replace="~{common/sidebar :: sidebar}"></div>
    <div class="main-content">
      <!-- 검색 창 -->
      <div th:replace="~{common/search :: searchForm}"></div>

      <h5 class="title">국내 지수</h5>
      <div class="stats" id="marketStats">
        <!-- 코스피, 코스닥, 코스피 200 등의 지수 정보를 여기서 렌더링 -->
      </div>
      <h5 class="title">관심 종목</h5>
      <div class="section-group">
        <div class="left-section">
          <div class="section">
            <h6>인기 종목</h6>
            <table class="stocks-table">
              <thead>
                <tr>
                  <th>종목명</th>
                  <th>현재가</th>
                  <th>등락률</th>
                  <th>시가총액</th>
                  <th>거래량/거래대금</th>
                </tr>
              </thead>
              <tbody id="stockBody">
                <!-- 주식 리스트 데이터가 동적으로 추가됩니다 -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="right-section">
          <div class="section assets-summary">
            <div class="flex-text-group">
              <p>총 자산</p>
              <p id="totalAsset" class="total-asset">0 원</p>
            </div>
            <div class="flex-text-group">
              <p>가용 자산</p>
              <p id="availableAsset" class="available-asset">0 원</p>
            </div>
          </div>
          <div class="section">
            <h6>보유 종목</h6>
            <table class="owned-stocks">
              <thead>
                <tr>
                  <th>종목명</th>
                  <th>현재가</th>
                  <th>등락률</th>
                </tr>
              </thead>
              <tbody id="ownedStockBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        initializePageData();
      });

      function initializePageData() {
        fetchMarketStats();
        fetchStockList();

        const memberKeyElement = document.getElementById("memberKey");
        if (memberKeyElement && memberKeyElement.value) {
          const userId = memberKeyElement.value;
          fetchOwnedStocks(userId);
          fetchUserAssets(userId);
        } else {
          console.log("User not logged in or memberKey not available");
          updateUIForLoggedOutUser();
        }
      }

      function updateUIForLoggedOutUser() {
        // 로그인하지 않은 사용자를 위한 UI 업데이트
        document.getElementById("totalAsset").textContent = "로그인 필요";
        document.getElementById("availableAsset").textContent = "로그인 필요";
        document.getElementById("ownedStockBody").innerHTML =
          '<tr><td colspan="3">로그인이 필요합니다</td></tr>';
      }

      async function getUserInfo(accessToken) {
        try {
          const response = await axios.get("/members/info", {
            headers: { Authorization: `Bearer ${accessToken}` },
          });
          document.getElementById("userName").textContent = response.data.name;
          return response.data;
        } catch (error) {
          console.error("Failed to fetch member info:", error);
        }
      }

      function logout() {
        axios
          .get("/auth/logout")
          .then(() => (window.location.href = "/login"))
          .catch((error) => alert("로그아웃 중 오류가 발생했습니다."));
      }

      function getCookie(cookieName) {
        let name = cookieName + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let cookieArray = decodedCookie.split(";");
        for (let i = 0; i < cookieArray.length; i++) {
          let cookie = cookieArray[i].trim();
          if (cookie.indexOf(name) === 0) return cookie.substring(name.length);
        }
        return "";
      }

      // 국내 지수 정보 가져오기
      async function fetchMarketStats() {
        let accessToken = getCookie("Authorization");
        console.log("국내지수 부르기");
        const indices = [
          { idxCsf: "KOSPI시리즈", idxNm: "코스피" },
          { idxCsf: "KOSDAQ시리즈", idxNm: "코스닥" },
          { idxCsf: "KOSPI시리즈", idxNm: "코스피 200" },
        ];

        const marketStats = document.getElementById("marketStats");
        marketStats.innerHTML = ""; // 기존 내용을 지워 초기화

        // 순차적으로 요청하여 순서 보장
        for (const index of indices) {
          const { idxCsf, idxNm } = index;

          try {
            // 각 인덱스에 대해 순차적으로 API 요청
            const response = await axios.get(`/api/stock/index/${idxCsf}/${idxNm}`);
            const statData = response.data;

            // 상승/하락에 따른 스타일 및 아이콘 설정
            const isUp = parseFloat(statData.fltRt) > 0;
            const color = isUp ? "red" : "blue";
            const icon = isUp ? "▲" : "▼";

            // HTML 카드 생성
            const cardHTML = `
                    <div class="stat-box">
                        <h6 class="stat-name">${statData.idxNm}</h6>
                        <p class="stat-value" style="font-size: 24px; color: ${color};">${statData.clpr}</p>
                        <p class="stat-change" style="color: ${color};">
                            ${icon} ${statData.vs} (${statData.fltRt}%)
                        </p>
                    </div>
                `;

            // 카드 추가
            marketStats.innerHTML += cardHTML;
            //getUserInfo(accessToken);
          } catch (error) {
            console.error(`Error fetching market stats for ${idxNm}:`, error);
          }
        }
      }

      // 주식 리스트 정보 가져오기(현재는 그냥 단순 리스트)
      async function fetchStockList() {
        let accessToken = getCookie("Authorization");
        console.log("관심 종목 리스트 가져오기");

        axios
          .get("/api/stock/list")
          .then((response) => {
            console.log("응답 데이터 타입:", typeof response.data); // 데이터 타입 확인
            console.log("응답 데이터 구조:", response.data); // 데이터가 예상과 일치하는지 확인
            const tbody = document.getElementById("stockBody");
            tbody.innerHTML = ""; // 기존 내용을 지우기

            if (Array.isArray(response.data) && response.data.length > 0) {
              response.data.forEach((stock) => {
                const fltRtValue = parseFloat(stock.fltRt); // 등락률을 숫자로 변환
                let color = "black"; // 기본 색상
                let icon = "-"; // 기본 아이콘

                // 등락률에 따른 색상 및 아이콘 설정
                if (fltRtValue > 0) {
                  color = "red"; // 상승일 때 빨간색
                  icon = "▲"; // 상승 아이콘
                } else if (fltRtValue < 0) {
                  color = "blue"; // 하락일 때 파란색
                  icon = "▼"; // 하락 아이콘
                }

                // 거래량 및 거래대금을 정리
                const formattedTrqu = Number(stock.trqu).toLocaleString(); // 거래량
                const formattedTrPrc = Number(stock.trPrc).toLocaleString(); // 거래대금

                // 시가 총액 포맷
                const formattedMrktTotAmt = Number(stock.mrktTotAmt).toLocaleString() + " 원";

                // HTML 행 생성
                const rowHTML = `
                            <tr>
                                <td><a href="/stock/detail/${stock.srtnCd}?marketCategory=${stock.mrktCtg}">${stock.itmsNm}</a></td>
                                <td style="color: ${color}">${stock.clpr}</td>
                                <td style="color: ${color}">${icon} ${stock.fltRt}%</td>
                                <td>${formattedMrktTotAmt}</td>
                                <td>${formattedTrqu}<br/><p class="additional-value">${formattedTrPrc} 원</p></td>
                            </tr>`;

                // 테이블에 행 추가
                tbody.innerHTML += rowHTML;
              });
            } else {
              console.warn("관심 종목 데이터가 없습니다.");
              tbody.innerHTML = `<tr><td colspan="5">관심 종목 데이터가 없습니다.</td></tr>`;
            }
          })
          .catch((error) => {
            console.error("Error fetching stock list:", error);
            console.error("에러 상태 코드:", error.response?.status); // 에러 상태 코드 확인
            console.error("에러 메시지:", error.response?.data); // 에러 응답 내용 확인
            alert(
              `관심 종목을 가져오는 중 오류가 발생했습니다. (상태 코드: ${error.response?.status})`
            );
          });
      }

      // 시가총액 형식 변환 함수 (예: 18조 4,500억원)
      function formatMarketCap(value) {
        const units = ["억원", "조", "천억", "백억"];
        let formattedValue = value;

        // 억 단위로 변환
        const billions = (value / 1e8).toFixed(1);
        formattedValue = `${billions}억원`;

        return formattedValue;
      }

      // 거래량 형식 변환 함수 (예: 22,801,339)
      function formatVolume(volume) {
        return volume.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      // 거래대금 형식 변환 함수 (예: 1조 8,023억원)
      function formatPrice(price) {
        const billions = (price / 1e8).toFixed(1);
        return `${billions}억원`;
      }
    </script>
    <script th:replace="~{common/sidebar :: sidebar-script}"></script>
    <script th:replace="~{common/search :: search-script}"></script>
  </body>
</html>
