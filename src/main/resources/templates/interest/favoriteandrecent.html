<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head th:replace="~{common/header :: header}"></head>
<head>
    <title>관심 종목</title>
    <link rel="stylesheet" href="/layout/css/custom-favoriteandrecent-style.css" />

    <style>
        .section-group {
          margin-bottom : 40px;
        }

        .table-section {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-right: 20px;
        }

        .chart-section {
            flex: 2;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative; /* 화살표 아이콘 위치 조정을 위한 상대 위치 */
        }

        .filter-btn-group {
            display: inline-flex;
            background-color: #F7F7F7; /* 버튼 그룹의 배경색 */
            border-radius: 12px; /* 버튼 그룹의 둥근 모서리 */
            overflow: hidden;
            padding: 2px; /* 버튼과 그룹의 경계를 나누기 위한 패딩 */
        }

        .filter-btn-group button {
            border: none;
            padding: 5px 7px; /* 버튼 패딩 */
            font-family: "Pretendard-Regular";
            cursor: pointer;
            font-size: 15px;
            background-color: transparent; /* 기본적으로 투명한 배경 */
            color: black;
            margin: 0; /* 버튼 사이의 간격 제거 */
        }

        .filter-btn-group button.active {
            background-color: #3947b2; /* 활성화된 버튼의 배경색 */
            color: white;
            border-radius: 5px; /* 활성화된 버튼의 둥근 모서리 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 활성화된 버튼의 그림자 */
        }

        .filter-btn-group button:hover {
            background-color: #3947b2; /* 활성화된 버튼의 배경색 */
            color: white;
            border-radius: 5px; /* 활성화된 버튼의 둥근 모서리 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 활성화된 버튼의 그림자 */
        }

        .table-header {
            background-color: white;
            border-bottom: 1px #E0E0E0;
            margin-top:
        }

        .table-header th {
            padding: 15px;
            text-align: left;
            font-family: "Pretendard-SemiBold";
            color: #315784;
            background-color: white;
        }

        .table-wrapper {
            max-height: 400px; /* 테이블의 최대 높이 설정 */
            overflow-y: auto;  /* 높이를 초과할 경우 세로 스크롤 추가 */
            margin-top: 0px;  /* 테이블 상단에 간격 추가 */
        }

        /* 모든 브라우저에서 스크롤바 숨기기 */
        .table-wrapper::-webkit-scrollbar {
            display: none; /* 웹킷 기반 브라우저 (크롬, 사파리 등)에서 스크롤바 숨김 */
        }

        .stocks-header-table,
        .stocks-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stocks-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-family: "Pretendard-Medium";
            margin: 0px;
        }

        /* 활성화된 항목의 스타일 (파란색 배경) */
        .stocks-table tr.active {
            background-color: #3947b2;
            color: white;
        }

        .stocks-table td.up {
            color: #ea4335;
            /* 상승률 */
        }

        .stocks-table td.down {
            color: #4285f4;
            /* 하락률 */
        }

        tr:hover {
            background: #f1f1f1;
        }

        tr.selected {
            background: #3947b2;
            color: white;
        }

        .chart-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .stock-info {
            display: flex;
            align-items: center;
        }

        .stock-icon {
            color: gold;
            margin-right: 8px;
            font-size: 18px;
        }

        .stock-details {
            margin-left: 15px;
        }

        .stock-name {
            font-family: "Pretendard-SemiBold";
            font-size: 20px;
        }

        .stock-price {
            font-family: "Pretendard-Bold";
            color: #ea4335;
            font-size: 24px;
            margin-left: 10px;
        }

        .stock-code {
            font-family: "Pretendard-Regular";
            color: #777;
            font-size: 14px;
            margin-top: 5px;
        }

        .stock-change {
            font-family: "Pretendard-Medium";
            font-size: 14px;
            color: #ea4335;
            margin-top: 5px;
        }

        .chart-box {
            height: 400px;
        }

        .details-link {
            margin-left: auto;
            font-size: 24px;
            text-decoration: none;
            color: #b0b0b0;
            align-self: center;

        }
    </style>
</head>

<body class="body">
<div th:replace="~{common/sidebar :: sidebar}"></div>

<div class="main-content">
    <!-- 검색 창 -->
    <div th:replace="~{common/search :: searchForm}"></div>

    <!-- 즐겨찾기 영역 -->
    <h5 class="title">즐겨찾기</h5>
    <div class="section-group">
        <div class="table-section" id="favorites-section">
            <div class="filter-btn-group" id="favorites-filter">
                <button class="filter-btn active" data-filter="ALL" onclick="applyFavoriteFilter('ALL')">전체</button>
                <button class="filter-btn" data-filter="KOSPI" onclick="applyFavoriteFilter('KOSPI')">코스피</button>
                <button class="filter-btn" data-filter="KOSDAQ" onclick="applyFavoriteFilter('KOSDAQ')">코스닥</button>
            </div>

            <!-- 테이블 헤더를 별도로 배치 -->
            <div class="table-header">
                <table class="stocks-header-table">
                    <thead>
                    <tr>
                        <th>종목명</th>
                        <th>현재가</th>
                        <th>등락률</th>
                    </tr>
                    </thead>
                </table>
            </div>

            <div class="table-wrapper">
                <table class="stocks-table">
                    <tbody id="favorites-tbody">
                    <!-- 즐겨찾기 종목 데이터가 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 차트 영역 -->
        <div class="chart-section">
            <div class="chart-title">
                <div class="stock-info">
                    <i class="fa-solid fa-star stock-icon"></i>
                    <div class="stock-details">
                        <div id="favorite-stock-name" class="stock-name">-</div>
                        <div id="favorite-stock-code" class="stock-code">-</div>
                    </div>
                </div>
                <div>
                    <span id="favorite-stock-price" class="stock-price">-</span><br>
                    <span id="favorite-stock-change" class="stock-change">▲ - | -%</span>
                </div>
                <a id="favorite-detail-link" href="#" class="details-link"><i class="fas fa-chevron-right"></i></a>
            </div>
            <div id="favoriteChart1" class="chart-box"></div>
        </div>
    </div>

    <!-- 최근 조회 영역 -->
    <h5 class="title">최근 조회</h5>
    <div class="section-group">
        <div class="table-section" id="recent-section">
            <div class="filter-btn-group" id="recent-filter">
                <button class="filter-btn active" data-filter="ALL" onclick="applyFilter('ALL', 'recent-tbody')">전체</button>
                <button class="filter-btn" data-filter="KOSPI" onclick="applyFilter('KOSPI', 'recent-tbody')">코스피</button>
                <button class="filter-btn" data-filter="KOSDAQ" onclick="applyFilter('KOSDAQ', 'recent-tbody')">코스닥</button>
            </div>

            <!-- 테이블 헤더를 별도로 배치 -->
            <div class="table-header">
                <table class="stocks-header-table">
                    <thead>
                    <tr>
                        <th>종목명</th>
                        <th>현재가</th>
                        <th>등락률</th>
                    </tr>
                    </thead>
                </table>
            </div>

            <div class="table-wrapper">
                <table class="stocks-table">
                    <tbody id="recent-tbody">
                    <tr class="active">
                        <td>삼성전자</td>
                        <td>79,600</td>
                        <td class="up">+1.27%</td>
                    </tr>
                    <tr>
                        <td>에코프로비엠</td>
                        <td>200,500</td>
                        <td class="down">-4.07%</td>
                    </tr>
                    <tr class="active">
                        <td>삼성전자</td>
                        <td>79,600</td>
                        <td class="up">+1.27%</td>
                    </tr>
                    <tr>
                        <td>에코프로비엠</td>
                        <td>200,500</td>
                        <td class="down">-4.07%</td>
                    </tr>
                    <tr class="active">
                        <td>삼성전자</td>
                        <td>79,600</td>
                        <td class="up">+1.27%</td>
                    </tr>
                    <tr>
                        <td>에코프로비엠</td>
                        <td>200,500</td>
                        <td class="down">-4.07%</td>
                    </tr>
                    <tr class="active">
                        <td>삼성전자</td>
                        <td>79,600</td>
                        <td class="up">+1.27%</td>
                    </tr>
                    <tr>
                        <td>에코프로비엠</td>
                        <td>200,500</td>
                        <td class="down">-4.07%</td>
                    </tr>
                    <tr class="active">
                        <td>삼성전자</td>
                        <td>79,600</td>
                        <td class="up">+1.27%</td>
                    </tr>
                    <tr>
                        <td>에코프로비엠</td>
                        <td>200,500</td>
                        <td class="down">-4.07%</td>
                    </tr>
                    <tr class="active">
                        <td>삼성전자</td>
                        <td>79,600</td>
                        <td class="up">+1.27%</td>
                    </tr>
                    <tr>
                        <td>에코프로비엠</td>
                        <td>200,500</td>
                        <td class="down">-4.07%</td>
                    </tr>
                    <tr class="active">
                        <td>삼성전자</td>
                        <td>79,600</td>
                        <td class="up">+1.27%</td>
                    </tr>
                    <tr>
                        <td>에코프로비엠</td>
                        <td>200,500</td>
                        <td class="down">-4.07%</td>
                    </tr>
                    <tr class="active">
                        <td>삼성전자</td>
                        <td>79,600</td>
                        <td class="up">+1.27%</td>
                    </tr>
                    <tr>
                        <td>에코프로비엠</td>
                        <td>200,500</td>
                        <td class="down">-4.07%</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 차트 영역 -->
        <div class="chart-section">
            <div class="chart-title">
                <div class="stock-name">
                    <i class="fa-solid fa-star stock-icon"></i>
                    <span>삼성전자</span>
                </div>
                <div>
                    <span class="stock-price">79,600</span><br>
                    <span class="stock-change">▲ 1,000 | +1.27%</span> <!-- 가격 변동 정보 추가 -->
                </div>
            </div>
            <div id="recentChart" class="chart-box"></div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const memberKeyElement = document.getElementById('memberKey');

        if (memberKeyElement) {
            const userId = memberKeyElement.value;
            // 즐겨찾기 영역의 데이터를 기본으로 불러오기
            fetchFavoriteStocks('ALL', userId);
        } else {
            console.error('memberKeyElement를 찾을 수 없습니다.');
        }

        // 즐겨찾기 차트에서 별 아이콘 클릭 이벤트 리스너 추가
        const starIcon = document.querySelector('.stock-icon');
        starIcon.addEventListener('click', function () {
            removeFromFavorites();
        });
    });

    function applyFavoriteFilter(filter) {
        // 필터 버튼 그룹에서 특정 필터 버튼을 활성화합니다.
        const filterGroup = document.querySelector('#favorites-filter');
        filterGroup.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));

        // 현재 클릭한 버튼에 active 클래스 추가
        event.target.classList.add('active');

        // 필터 적용 후 데이터를 새로 가져옵니다.
        const memberKeyElement = document.getElementById('memberKey');
        if (memberKeyElement) {
            const userId = memberKeyElement.value;
            fetchFavoriteStocks(filter, userId);
        }
    }

    function fetchFavoriteStocks(marketType, userId) {
        axios.get(`/api/favorites/member`, {
            params: {
                userId: userId,
                marketType: marketType
            }
        })
        .then(response => {
            const favoriteStocks = response.data; // 백엔드에서 가져온 즐겨찾기 종목 데이터
            updateFavoriteTable(favoriteStocks);
        })
        .catch(error => {
            console.error('즐겨찾기 데이터를 가져오는 중 오류 발생:', error);
        });
    }

    function updateFavoriteTable(stockData) {
        const tbody = document.getElementById('favorites-tbody');
        if (!tbody) {
            console.error('favorites-tbody 요소를 찾을 수 없습니다.');
            return;
        }
        tbody.innerHTML = ''; // 기존 내용을 지우기

        stockData.forEach((stock, index) => {
            if (stock) {
                const fltRtValue = parseFloat(stock.priceChangeRate);
                let color = 'black';
                let icon = '-';

                // 등락률에 따른 색상 및 아이콘 설정
                if (fltRtValue > 0) {
                    color = 'red';
                    icon = '▲';
                } else if (fltRtValue < 0) {
                    color = 'blue';
                    icon = '▼';
                }

                // 테이블 행 추가 (각 행을 클릭하면 차트 헤더 내용이 바뀜)
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stock.stockName}</td>
                    <td style="color: ${color}">${stock.currentPrice}</td>
                    <td style="color: ${color}">${icon} ${stock.priceChangeRate}%</td>
                `;
                row.onclick = () => updateChartSection(row, stock);

                // 첫 번째 항목 선택 처리
                if (index === 0) {
                    row.classList.add('selected');
                    updateChartSection(row, stock);
                }

                tbody.appendChild(row);
            }
        });
    }

    function updateChartSection(selectedRow, stock) {
        // 이전에 선택된 행의 클래스 제거
        const rows = document.querySelectorAll('#favorites-tbody tr');
        rows.forEach(row => row.classList.remove('selected'));

        // 현재 선택된 행의 클래스 추가
        selectedRow.classList.add('selected');

        // 차트 영역 업데이트
        document.getElementById('favorite-stock-name').textContent = stock.stockName;
        document.getElementById('favorite-stock-code').textContent = stock.stockCode;
        document.getElementById('favorite-stock-price').textContent = stock.currentPrice;

        const fltRtValue = parseFloat(stock.priceChangeRate);
        let color = 'black';
        let icon = '-';
        if (fltRtValue > 0) {
            color = 'red';
            icon = '▲';
        } else if (fltRtValue < 0) {
            color = 'blue';
            icon = '▼';
        }

        document.getElementById('favorite-stock-change').textContent = `${icon} ${stock.priceChange} | ${fltRtValue}%`;
        document.getElementById('favorite-stock-change').style.color = color;

        // 상세 페이지 링크 업데이트
        const detailLink = document.getElementById('favorite-detail-link');
        detailLink.href = `/stock/detail/${stock.stockCode}?marketCategory=${stock.marketType}`;
    }

    function removeFromFavorites() {
        // 차트 영역에서 현재 선택된 종목의 정보를 가져옴
        const stockCode = document.getElementById('favorite-stock-code').textContent.trim();
        const memberKeyElement = document.getElementById('memberKey');

        if (memberKeyElement && stockCode) {
            const userId = memberKeyElement.value;

            axios.post('/api/favorites/remove', null, { // null은 POST 요청의 request body에 아무것도 보내지 않는다는 의미
                params: {
                    userId: userId,
                    stockCode: stockCode
                }
            })
            .then(response => {
                alert(response.data.message || '즐겨찾기에서 제거되었습니다.');
                window.location.reload();
            })
            .catch(error => {
                console.error('즐겨찾기 제거 중 오류 발생:', error);
                alert('즐겨찾기 제거에 실패했습니다. 다시 시도해 주세요.');
            });
        } else {
            alert('주식 정보를 찾을 수 없습니다.');
        }
    }
</script>

<!-- 스크립트는 body 끝 부분에 배치 -->
<script th:replace="~{common/sidebar :: sidebar-script}"></script>

<script th:replace="~{common/search :: search-script}"></script>
</body>
</html>