<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{common/header :: header}"> </head>
  <body>
    <div th:replace="~{common/sidebar :: sidenav}"></div>
    <div class="main-content">
      <header class="profile-header">
        <div class="profile-picture">
          <button class="edit-button">✏️</button>
        </div>
        <div class="profile-info">
          <h2>박 유경</h2>
          <p>8만 전자를 향하여</p>
        </div>
        <button class="logout-button">로그아웃</button>       
      </header>
      <h5 class="title">보유중인 종목</h5>
      <div class="section-group">
        <div class="left-section">
          <div class="section">
            <table class="stocks-table">
              <thead>
                <tr>
                  <th>종목명</th>
                  <th>보유량</th>
                  <th>현재가</th>
                  <th>수익률</th>
                  <th>평균매수가</th>
                  <th>최소매수가</th>
                  <th>최대매수가</th>
                </tr>
              </thead>
              <tbody id="stockBody">
                <!-- 주식 리스트 데이터가 동적으로 추가됩니다 -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="right-section">
          <div class="section assets-summary">
            <div class="flex-text-group">
              <p>총 자산</p>
              <p id="totalAsset" class="total-asset">0 원</p>
            </div>
            <div class="flex-text-group">
              <p>가용 자산</p>
              <p id="availableAsset" class="available-asset">0 원</p>
            </div>
          </div>
          <div class="section">
            <h6>보유 종목</h6>
            <table class="owned-stocks">
              <thead>
                <tr>
                  <th>종목명</th>
                  <th>현재가</th>
                  <th>등락률</th>
                </tr>
              </thead>
              <tbody id="ownedStockBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- 로그아웃 스크립트 포함 -->
    <div th:replace="~{common/sidebar :: logout-script}"></div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        initializePageData();
      });

      function initializePageData() {
        const memberKeyElement = document.getElementById('memberKey');
        if (memberKeyElement && memberKeyElement.value) {
          const userId = memberKeyElement.value;
          fetchStockList(userId);
          //fetchOwnedStocks(userId);
          //fetchUserAssets(userId);
        } else {
          console.log('세션이 만료되었습니다. 재로그인해주세요.');
          logout();
        }
      }

      function logout() {
        axios
          .get('/auth/logout')
          .then(() => (window.location.href = '/login'))
          .catch((error) => alert('로그아웃 중 오류가 발생했습니다.'));
      }

      function getCookie(cookieName) {
        let name = cookieName + '=';
        let decodedCookie = decodeURIComponent(document.cookie);
        let cookieArray = decodedCookie.split(';');
        for (let i = 0; i < cookieArray.length; i++) {
          let cookie = cookieArray[i].trim();
          if (cookie.indexOf(name) === 0) return cookie.substring(name.length);
        }
        return '';
      }

      // 주식 리스트 정보 가져오기(현재는 그냥 단순 리스트)
      async function fetchStockList(userId) {
        let accessToken = getCookie('Authorization');
        console.log('보유중인 종목 리스트 가져오기');

        console.log('userId = ' +userId);
        axios
          .get(`/api/mypage/${userId}/userStock`)
          .then((response) => {
            console.log('응답 데이터 타입:', typeof response.data); // 데이터 타입 확인
            console.log('응답 데이터 구조:', response.data); // 데이터가 예상과 일치하는지 확인
            const tbody = document.getElementById('stockBody');
            tbody.innerHTML = ''; // 기존 내용을 지우기

            if (Array.isArray(response.data) && response.data.length > 0) {
              response.data.forEach((stock) => {
                //매수 평균가
                const formattedAvgPrice =
                  Number(stock.avgPrice).toLocaleString() + ' 원';
                //최소 매수가
                const formattedMinPrice =
                  Number(stock.minPrice).toLocaleString() + ' 원';
                //최대 매수가
                const formattedMaxPrice =
                  Number(stock.maxPrice).toLocaleString() + ' 원';
                //누적합
                const formattedtotalPrice =
                  Number(stock.totalPrice).toLocaleString() + ' 원';

                // HTML 행 생성
                const rowHTML = `
                            <tr>
                                <td><a href="/stock/detail/${stock.stockCode}?marketCategory=${stock.mrtgType}">${stock.stockName}</a></td>
                                <td>보유량</td>
                                <td>현재가</td>
                                <td>수익률</td>
                                <td>${formattedAvgPrice}</td>
                                <td>${formattedMinPrice}</td>
                                <td>${formattedMaxPrice}</td>
                                <td>${formattedMrktTotAmt}</td>
                            </tr>`;

                // 테이블에 행 추가
                tbody.innerHTML += rowHTML;
              });
            } else {
              console.warn('보유중인 종목 데이터가 없습니다.');
              tbody.innerHTML = `<tr><td colspan="5">보유중인 종목 데이터가 없습니다.</td></tr>`;
            }
          })
          .catch((error) => {
            console.error('Error fetching stock list:', error);
            console.error('에러 상태 코드:', error.response?.status); // 에러 상태 코드 확인
            console.error('에러 메시지:', error.response?.data); // 에러 응답 내용 확인
            alert(
              `보유중인 종목을 가져오는 중 오류가 발생했습니다. (상태 코드: ${error.response?.status})`
            );
          });
      }

      // 시가총액 형식 변환 함수 (예: 18조 4,500억원)
      function formatMarketCap(value) {
        const units = ['억원', '조', '천억', '백억'];
        let formattedValue = value;

        // 억 단위로 변환
        const billions = (value / 1e8).toFixed(1);
        formattedValue = `${billions}억원`;

        return formattedValue;
      }

      // 거래량 형식 변환 함수 (예: 22,801,339)
      function formatVolume(volume) {
        return volume.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      // 거래대금 형식 변환 함수 (예: 1조 8,023억원)
      function formatPrice(price) {
        const billions = (price / 1e8).toFixed(1);
        return `${billions}억원`;
      }
    </script>
  </body>
</html>
