<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/header :: header}"></head>
<body style="background-color: #f2f6fb">
<div th:replace="~{common/sidebar :: sidebar}"></div>
<div class="main-content">
    <header class="profile-header">
        <div class="profile-picture">
            <img
                    src="/layout/srcs/icons/user-logo.svg"
                    alt="icon"
                    class="flex-component profile-img"
            />
        </div>
        <div class="profile-info">
            <h2 id="userNickname">로그인 후 이용해주세요.</h2>
            <p id="userComment">로그인 후 이용해주세요.</p>
        </div>
        <div class="logout-button-group">
            <button class="modify-button" onclick="openModal()">수정</button>
            <button class="logout-button" onclick="logout()">로그아웃</button>
        </div>
    </header>
    <hr/>
    <h5 class="title mypage-have-stock">보유중인 종목</h5>
    <div class="section-group">
        <div class="mypage-left-section">
            <div class="section">
                <!--                보유 종목 리스트 -->
                <!-- 필터 버튼 그룹 -->
                <div class="filter-btn-group">
                    <button name = "have-stock-filter-btn" class="filter-btn active" onclick="haveStockMarketFilter('ALL')">전체</button>
                    <button name = "have-stock-filter-btn" class="filter-btn" onclick="haveStockMarketFilter('KOSPI')">코스피</button>
                    <button name = "have-stock-filter-btn" class="filter-btn" onclick="haveStockMarketFilter('KOSDAQ')">코스닥</button>
                </div>
                <table class="stocks-table">
                    <thead>
                    <tr>
                        <th>종목명</th>
                        <th>보유량</th>
                        <th>현재가</th>
                        <th>수익률</th>
                        <th>평균매수가</th>
                        <th>최소매수가</th>
                        <th>최대매수가</th>
                        <th>총 매수가</th>
                    </tr>
                    </thead>
                    <tbody id="haveStockBody">
                    <!-- 주식 리스트 데이터가 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>
            <h5 class="title">관심 종목</h5>
            <div class="section">
                <div class="filter-btn-group">
                    <button name = "like-filter-btn" class="filter-btn active" onclick="likeMarketFilter('ALL')">전체</button>
                    <button name = "like-filter-btn" class="filter-btn" onclick="likeMarketFilter('KOSPI')">코스피</button>
                    <button name = "like-filter-btn" class="filter-btn" onclick="likeMarketFilter('KOSDAQ')">코스닥</button>
                </div>
                <table class="stocks-table" id="favorites-table">
                    <thead>
                    <tr>
                        <th>종목명</th>
                        <th>현재가</th>
                        <th>등락률</th>
                    </tr>
                    </thead>
                    <tbody id="favoriteStockBody">
                </table>
            </div>
        </div>

        <div class="mypage-section">
            <h6>자산 정보</h6>
            <form>
                <div class="asset-group" id="stock-holding-info">
                    <label>총 자산</label>
                    <p id="total-assets" class="total-asset">- 원</p>
                </div>
                <hr/>
                <div class="asset-group">
                    <label>가용 자산</label>
                    <p id="available-assets" class="available-asset">- 원</p>
                </div>
                <hr/>
                <div class="asset-group">
                    <label>보유 주식 총액</label>
                    <p id="stock-total" class="available-asset">- 원</p>
                </div>
                <hr/>
                <div class="asset-group">
                    <label>손익</label>
                    <p id="profit" class="available-asset">- 원</p>
                </div>

                <div class="submit-group">
                    <button type="submit" class="reset-button" onclick="resetAccount()">자산 초기화</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 모달창 -->
<div class="modal-background" id="editModal">
    <div class="modal-container">
        <button class="modal-close-button" onclick="closeModal()">X</button>
        <h2>정보 수정</h2>
        <div class="modal-input-group">
            <label for="nickname">닉네임</label>
            <input type="text" id="nickname" value="닉네임을 입력해주세요."/>
        </div>
        <div class="modal-input-group">
            <label for="intro">한 줄 소개</label>
            <textarea id="intro"></textarea>
        </div>
        <button class="modal-save-button" onclick="saveChanges()">저장</button>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
      initializePageData();
    });

    function initializePageData() {
      const memberKeyElement = document.getElementById("memberKey");
      if (memberKeyElement && memberKeyElement.value) {
        const userId = memberKeyElement.value;
        getUserInfo(userId);
        fetchHaveStockList(userId);
        fetchUserAssets(userId);
        fetchFavoriteStockList(userId);
      } else {
        console.log("세션이 만료되었습니다. 재로그인해주세요.");
        logout();
      }
    }

    function logout() {
      axios
        .get("/auth/logout")
        .then(() => (window.location.href = "/login"))
        .catch((error) => alert("로그아웃 중 오류가 발생했습니다."));
    }

    function getCookie(cookieName) {
      let name = cookieName + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let cookieArray = decodedCookie.split(";");
      for (let i = 0; i < cookieArray.length; i++) {
        let cookie = cookieArray[i].trim();
        if (cookie.indexOf(name) === 0) return cookie.substring(name.length);
      }
      return "";
    }

    async function getUserInfo(memberKey) {
      console.log("유저 정보 가져오기 memberKey : ", memberKey);
      axios.get(`/members/information/${memberKey}`).then((response) => {
        const userNameElement = document.getElementById('userNickname');
        const userCommentElement = document.getElementById('userComment');

        if (userNameElement && userCommentElement) {
            userNameElement.textContent = response.data.name;
            userCommentElement.textContent = response.data.comment;
        } else {
            console.error("userName 또는 userComment 엘리먼트를 찾을 수 없습니다.");
        }
      });
    }

    async function fetchUserAssets(userId) {
      console.log("유저 자산 정보 가져오기");

      axios.get(`/api/asset/${userId}`).then((response) => {
        const assetData = response.data;
        updateAssetInfo(assetData);  // 자산 정보를 업데이트
      })
      .catch(error => {
                console.error('Error fetching user assets:', error);
      });
    }

    // 자산 정보를 UI에 업데이트하는 함수
    function updateAssetInfo(assetData) {
        document.getElementById('total-assets').textContent = `${assetData.totalAssets.toLocaleString()} 원`;
        document.getElementById('available-assets').textContent = `${assetData.availableAsset.toLocaleString()} 원`; // 수정
        document.getElementById('stock-total').textContent = `${assetData.stockTotal.toLocaleString()} 원`;
        document.getElementById('profit').textContent = `${assetData.profit.toLocaleString()} 원`;
    }

    // 보유중인 종목 리스트 가져오기
    async function fetchHaveStockList(userId) {
      axios
        .get(`/api/myPage/${userId}/userStock`)
        .then((response) => {
          const tbody = document.getElementById("haveStockBody");
          tbody.innerHTML = ""; // 기존 내용을 지우기

          if (Array.isArray(response.data) && response.data.length > 0) {
            response.data.forEach((stock) => {
              //매수 평균가
              const formattedAvgPrice = Number(stock.avgPrice).toLocaleString() + " 원";
              //최소 매수가
              const formattedMinPrice = Number(stock.minPrice).toLocaleString() + " 원";
              //최대 매수가
              const formattedMaxPrice = Number(stock.maxPrice).toLocaleString() + " 원";
              //누적합
              const formattedTotalPrice = Number(stock.totalPrice).toLocaleString() + " 원";

              // HTML 행 생성
              const rowHTML = `
                          <tr>
                              <td><a href="/stock/detail/${stock.stockCode}?marketCategory=${stock.mrtgType}">${stock.stockName}</a></td>
                              <td>보유량</td>
                              <td>현재가</td>
                              <td>수익률</td>
                              <td>${formattedAvgPrice}</td>
                              <td>${formattedMinPrice}</td>
                              <td>${formattedMaxPrice}</td>
                              <td>${formattedTotalPrice}</td>
                          </tr>`;

              // 테이블에 행 추가
              tbody.innerHTML += rowHTML;
            });
          } else {
            console.warn("보유중인 종목 데이터가 없습니다.");
            tbody.innerHTML = `<tr><td colspan="5">보유중인 종목 데이터가 없습니다.</td></tr>`;
          }
        })
        .catch((error) => {
          alert(
            `보유중인 종목을 가져오는 중 오류가 발생했습니다. (상태 코드: ${error.response?.status})`
          );
        });
    }

    async function fetchFavoriteStockList(userId) {

         axios
          .get(`/api/favorites/member`, {
             params: {
                userId: userId,
                marketType: 'ALL'
            }
          })
          .then((response) => {
            const tbody = document.getElementById('favoriteStockBody');
            tbody.innerHTML = ''; // 기존 내용을 지우기

            const stockData = response.data;
            console.log(stockData);

            stockData.forEach((stock, index) => {
            if (stock) {
                const fltRtValue = parseFloat(stock.priceChangeRate);
                let color = 'black';
                let icon = '-';

                // 등락률에 따른 색상 및 아이콘 설정
                if (fltRtValue > 0) {
                    color = 'red';
                    icon = '▲';
                } else if (fltRtValue < 0) {
                    color = 'blue';
                    icon = '▼';
                }

                // 테이블 행 추가
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stock.stockName}</td>
                    <td style="color: ${color}">${stock.currentPrice} 원</td>
                    <td style="color: ${color}">${icon} ${stock.priceChangeRate}%</td>
                `;

                // 첫 번째 항목 선택 처리
                if (index === 0) {
                    row.classList.add('selected');
                }

                tbody.appendChild(row);
            }
        });
          })
          .catch((error) => {
            console.error('Error fetching stock list:', error);
            console.error('에러 상태 코드:', error.response?.status); // 에러 상태 코드 확인
            console.error('에러 메시지:', error.response?.data); // 에러 응답 내용 확인
            alert(
              `관심 종목을 가져오는 중 오류가 발생했습니다. (상태 코드: ${error.response?.status})`
            );
          });
    }

    // 시가총액 형식 변환 함수 (예: 18조 4,500억원)
    function formatMarketCap(value) {
      const units = ["억원", "조", "천억", "백억"];
      let formattedValue = value;

      // 억 단위로 변환
      const billions = (value / 1e8).toFixed(1);
      formattedValue = `${billions}억원`;

      return formattedValue;
    }

    // 거래량 형식 변환 함수 (예: 22,801,339)
    function formatVolume(volume) {
      return volume.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // 거래대금 형식 변환 함수 (예: 1조 8,023억원)
    function formatPrice(price) {
      const billions = (price / 1e8).toFixed(1);
      return `${billions}억원`;
    }

    function openModal() {
      // 현재 화면에 표시된 닉네임과 한줄소개 가져오기
      const currentNickname = document.getElementById("userNickname").textContent;
      const currentComment = document.getElementById("userComment").textContent;

      // 모달 입력 필드에 현재 값 설정
      document.getElementById("nickname").value = currentNickname === "로그인 후 이용해주세요." ? "" : currentNickname;
      document.getElementById("intro").value = currentComment === "로그인 후 이용해주세요." ? "" : currentComment;

      // 모달 표시
      document.getElementById("editModal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("editModal").style.display = "none";
    }

    function saveChanges() {
      const nickname = document.getElementById("nickname").value;
      const intro = document.getElementById("intro").value;
      const memberKeyElement = document.getElementById('memberKey');

      if (!memberKeyElement || !memberKeyElement.value) {
        console.log('세션이 만료되었습니다.');
        logout();
        return;
      }

      const memberKey = memberKeyElement.value;
      const requestData = {
        name: nickname,
        comment: intro
      };

    // URL 패턴을 컨트롤러와 일치시킴
    axios.patch(`/members/${memberKey}`, requestData)
        .then(response => {
            if (response.data) {
                document.getElementById('userNickname').textContent = response.data.name;
                document.getElementById('userComment').textContent =
                    response.data.comment || '한 줄 소개가 없습니다';
                closeModal();
                alert('회원 정보가 성공적으로 수정되었습니다.');
            }
        })
        .catch(error => {
            console.error('Error updating member information:', error);
            let errorMessage = '회원 정보 수정 중 오류가 발생했습니다.';

            if (error.response?.status === 401) {
                errorMessage = '세션이 만료되었습니다. 다시 로그인해주세요.';
                logout();
            } else if (error.response?.data?.message) {
                errorMessage = error.response.data.message;
            }
            alert(errorMessage);
        });
    }

    function resetAccount() {
        const memberKeyElement = document.getElementById('memberKey');

          if (!memberKeyElement || !memberKeyElement.value) {
            console.log('세션이 만료되었습니다.');
            logout();
            return;
          }

          const memberKey = memberKeyElement.value;
         axios.delete(`api/myPage/${memberKey}/reset`)
                .then((response) => {
                    console.log(response.data);
                    window.location.href = "/mypage";
                })
                .catch((error) => alert("초기화 중 오류가 발생했습니다."));
    }

    function haveStockMarketFilter(filter) {
        currentFilter = filter;
        document.getElementsByName('have-stock-filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        const memberKeyElement = document.getElementById("memberKey");
        if (memberKeyElement && memberKeyElement.value) {
            const userId = memberKeyElement.value;
            getUserHaveMarketStock(userId, filter);
        } else {
            console.log("세션이 만료되었습니다. 재로그인해주세요.");
            logout();
        }
    }

    function likeMarketFilter(filter){
        currentFilter = filter;
        document.getElementsByName('like-filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        const memberKeyElement = document.getElementById("memberKey");
        if (memberKeyElement && memberKeyElement.value) {
            const userId = memberKeyElement.value;
            getUserLikeMarketStock(userId, filter);
        } else {
            console.log("세션이 만료되었습니다. 재로그인해주세요.");
            logout();
        }
    }

    function getUserLikeMarketStock(userId, marketType) {
       axios
          .get(`/api/favorites/member`, {
             params: {
                userId: userId,
                marketType: marketType
            }
          })
          .then((response) => {
            const tbody = document.getElementById('favoriteStockBody');
            tbody.innerHTML = ''; // 기존 내용을 지우기

            const stockData = response.data;

            stockData.forEach((stock, index) => {
            if (stock) {
                const fltRtValue = parseFloat(stock.priceChangeRate);
                let color = 'black';
                let icon = '-';

                // 등락률에 따른 색상 및 아이콘 설정
                if (fltRtValue > 0) {
                    color = 'red';
                    icon = '▲';
                } else if (fltRtValue < 0) {
                    color = 'blue';
                    icon = '▼';
                }

                // 테이블 행 추가 (각 행을 클릭하면 차트 헤더 내용이 바뀜)
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stock.stockName}</td>
                    <td style="color: ${color}">${stock.currentPrice} 원</td>
                    <td style="color: ${color}">${icon} ${stock.priceChangeRate}%</td>
                `;

                // 첫 번째 항목 선택 처리
                if (index === 0) {
                    row.classList.add('selected');
                }

                tbody.appendChild(row);
            }
        });
          })
          .catch((error) => {
            console.error('Error fetching stock list:', error);
            console.error('에러 상태 코드:', error.response?.status); // 에러 상태 코드 확인
            console.error('에러 메시지:', error.response?.data); // 에러 응답 내용 확인
            alert(
              `관심 종목을 가져오는 중 오류가 발생했습니다. (상태 코드: ${error.response?.status})`
            );
          });
    }

    function getUserHaveMarketStock(userId, market) {
        axios.get(`/api/myPage/${userId}/${market}/userStock`)
        .then((response) => {
          const tbody = document.getElementById("haveStockBody");
          tbody.innerHTML = ""; // 기존 내용을 지우기

          if (Array.isArray(response.data) && response.data.length > 0) {
            response.data.forEach((stock) => {
              //매수 평균가
              const formattedAvgPrice = Number(stock.avgPrice).toLocaleString() + " 원";
              //최소 매수가
              const formattedMinPrice = Number(stock.minPrice).toLocaleString() + " 원";
              //최대 매수가
              const formattedMaxPrice = Number(stock.maxPrice).toLocaleString() + " 원";
              //누적합
              const formattedTotalPrice = Number(stock.totalPrice).toLocaleString() + " 원";

              // HTML 행 생성
              const rowHTML = `
                          <tr>
                              <td><a href="/stock/detail/${stock.stockCode}?marketCategory=${stock.mrtgType}">${stock.stockName}</a></td>
                              <td>보유량</td>
                              <td>현재가</td>
                              <td>수익률</td>
                              <td>${formattedAvgPrice}</td>
                              <td>${formattedMinPrice}</td>
                              <td>${formattedMaxPrice}</td>
                              <td>${formattedTotalPrice}</td>
                          </tr>`;

              // 테이블에 행 추가
              tbody.innerHTML += rowHTML;
            });
          } else {
            console.warn("보유중인 종목 데이터가 없습니다.");
            tbody.innerHTML = `<tr><td colspan="5">보유중인 종목 데이터가 없습니다.</td></tr>`;
          }
        })
        .catch((error) => {
          alert(
            `보유중인 종목을 가져오는 중 오류가 발생했습니다. (상태 코드: ${error.response?.status})`
          );
        });
    }
</script>
<!-- 스크립트는 body 끝 부분에 배치 -->
<script th:replace="~{common/sidebar :: sidebar-script}"></script>
</body>
</html>
