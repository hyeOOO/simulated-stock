<!DOCTYPE html>
<html
        lang="ko"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head th:replace="~{common/header_not_include_css :: header}"></head>
<head>
    <link rel="stylesheet" href="/layout/css/custom-assetmanagement-style.css" />
</head>
<body class="body">
<div th:replace="~{common/sidebar :: sidenav}"></div>

<div class="main-content">
    <div class="search-group">
        <i class="fa-solid fa-magnifying-glass fa-lg" style="color: #315784;"></i>
        <input type="text" class="search-control" placeholder="검색어를 입력하세요.">
    </div>

    <!-- 자산 현황 -->
    <h5 class="title">자산 현황</h5>
    <div class="stats-container">
        <!-- 자산 정보 -->
        <div class="stat-box">
            <h6>자산 정보</h6>
            <table>
                <tr>
                    <td>총 자산</td>
                    <td id="total-assets">- 원</td>
                </tr>
                <tr>
                    <td>가용 자산</td>
                    <td id="available-assets">- 원</td>
                </tr>
                <tr>
                    <td>보유 주식 총액</td>
                    <td id="stock-total">- 원</td>
                </tr>
                <tr>
                    <td>손익</td>
                    <td id="profit">- 원</td>
                </tr>
                <tr>
                    <td>손익률</td>
                    <td id="profit-rate">-%</td>
                </tr>
            </table>
        </div>

        <!-- 보유 종목 차트 -->
        <div class="chart-box">
            <h6 class="chart-title">보유 종목</h6>
            <canvas id="pieChart"></canvas>
        </div>

        <!-- 자산 기록 차트 -->
        <div class="chart-box">
            <h6 class="chart-title">자산 기록</h6>
            <canvas id="barChart"></canvas>
        </div>
    </div>

    <!-- 거래 기록 -->
    <h5 class="title">거래 기록</h5>
    <div class="section">

        <!-- 상단 필터 버튼 그룹 -->
        <div class="filter-btn-group">
            <button class="active" data-filter="ALL">전체</button>
            <button data-filter="BUY">매수</button>
            <button data-filter="SELL">매도</button>
        </div>

        <!-- 거래 기록 테이블 -->
        <table class="order-info-table">
            <thead>
            <tr>
                <th>종목명</th>
                <th>거래타입</th>
                <th>가격</th>
                <th>수량</th>
                <th>총 가격</th>
            </tr>
            </thead>
            <tbody>
            <!-- 주문 기록이 여기에 동적으로 추가됩니다 -->
            </tbody>
        </table>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        initializePageData(); // 비로그인 상태에서도 페이지 데이터 초기화
    });

    function initializePageData(userId) {
        const memberKeyElement = document.getElementById('memberKey');
        if (memberKeyElement && memberKeyElement.value) {
            const userId = memberKeyElement.value;
            fetchUserAssets(userId);  // 자산 정보 가져오기

            // 기본적으로 전체 기록을 가져오기
            fetchStockOrders(userId, 'ALL');

            // 필터 버튼 클릭 시 필터링된 데이터 가져오기
            document.querySelectorAll('.filter-btn-group button').forEach(button => {
                button.addEventListener('click', function () {
                    // 모든 버튼의 활성화 클래스를 제거
                    document.querySelectorAll('.filter-btn-group button').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // 필터 타입에 따라 거래 기록을 가져옴
                    const filterType = this.getAttribute('data-filter');
                    fetchStockOrders(userId, filterType);
                });
            });
        } else {
          console.log('User not logged in or memberKey not available');
        }
    }

    // 거래 기록을 가져오는 함수
    function fetchStockOrders(memberId, filterType = 'ALL') {
        let url = `/stock/order/${memberId}/all`;  // 기본값: 전체

        if (filterType === 'BUY') {
            url = `/stock/order/${memberId}/buy`;  // 매수 기록
        } else if (filterType === 'SELL') {
            url = `/stock/order/${memberId}/sell`;  // 매도 기록
        }

        axios.get(url)
            .then(response => {
                const orders = response.data;
                updateOrderTable(orders);  // 표 업데이트
            })
            .catch(error => {
                console.error('Error fetching orders:', error);
            });
    }

    // 표를 업데이트하는 함수
    function updateOrderTable(orders) {
        const tbody = document.querySelector('.order-info-table tbody');
        tbody.innerHTML = '';  // 기존 데이터를 비움

        orders.forEach(order => {
            const stockLink = `/stock/${order.stockCode}?marketCategory=${order.mrtgType}`; // 동적으로 링크 생성
            const row = `
                <tr>
                    <td>
                        <a href="${stockLink}">${order.stockName}</a> <!-- 동적으로 링크 설정 -->
                    </td>
                    <td class="order-type ${order.orderType === 'BUY' ? 'up' : 'down'}">
                        ${order.orderType === 'BUY' ? '매수' : '매도'}
                    </td>
                    <td>${order.price}</td>
                    <td>${order.quantity}</td>
                    <td>${(order.price * order.quantity).toLocaleString()}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    //자산 정보
    // 자산 정보를 가져오는 함수
    function fetchUserAssets(memberKey) {
        axios.get(`/api/asset/${memberKey}`)
            .then(response => {
                const assetData = response.data;
                updateAssetInfo(assetData);  // 자산 정보를 업데이트
            })
            .catch(error => {
                console.error('Error fetching user assets:', error);
            });
    }

    // 자산 정보를 UI에 업데이트하는 함수
    function updateAssetInfo(assetData) {
        document.getElementById('total-assets').textContent = `${assetData.totalAssets.toLocaleString()} 원`;
        document.getElementById('available-assets').textContent = `${assetData.availableAsset.toLocaleString()} 원`; // 수정
        document.getElementById('stock-total').textContent = `${assetData.stockTotal.toLocaleString()} 원`;
        document.getElementById('profit').textContent = `${assetData.profit.toLocaleString()} 원`;
        document.getElementById('profit-rate').textContent = `${assetData.profitRate}%`;
    }
</script>

<script>
    // Pie chart for 보유종목
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: ['삼성전자', '에코프로비엠', '현대차', '에코프로'],
            datasets: [{
                data: [997, 676, 788, 367],
                backgroundColor: ['#3947b2', '#f1c40f', '#e74c3c', '#2ecc71']
            }]
        }
    });

    // Bar chart for 자산 기록
    const barCtx = document.getElementById('barChart').getContext('2d');
    const barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['0', '1', '2', '3', '4'],
            datasets: [
                {
                    label: '보유 주식',
                    data: [600, 750, 600, 750, 600],
                    backgroundColor: '#3947b2'
                },
                {
                    label: '가용 자산',
                    data: [400, 500, 400, 500, 400],
                    backgroundColor: '#3498db'
                }
            ]
        }
    });
</script>
<script th:replace="~{common/sidebar :: sidenav-script}"></script>
</body>
</html>