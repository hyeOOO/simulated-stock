<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <head th:replace="~{common/header :: header}"></head>
</head>
<body style="background-color: #f2f6fb">
<div th:replace="~{common/sidebar :: sidebar}"></div>
<div class="main-content">
    <div th:replace="~{common/search :: searchForm}"></div>
    <h5 class="title">나의 순위</h5>
    <div class="div-white-box">
        <div>
            <img
                    src="/layout/srcs/icons/user-logo.svg"
                    alt="icon"
                    class="flex-component ranking-profile"
            />
        </div>
        <div class="ranking-profile-info">
            <h5 id="userNickname">로그인 후 이용해주세요.</h5>
            <p id="userAsset"></p>
        </div>
        <div class="user-rank">
            <i class="fa-solid fa-ranking-star fa-2xl user-rank-icon"></i>
            <p class="user-rank-number"></p>
        </div>
    </div>

    <h5 class="title">TOP 3</h5>
    <div class="stats">
        <div class="mini3-box">
            <div>
                <i class="fa-solid fa-ranking-star fa-xl top1-icon"></i>
            </div>
            <div>
                <img
                        src="/layout/srcs/icons/user-logo.svg"
                        alt="icon"
                        class="flex-component middle-ranking-profile"
                />
            </div>
            <div class="ranking-profile-info">
                <h6 class="userNickname">-님</h6>
                <p class="userAsset">-원</p>
            </div>
        </div>
        <div class="mini3-box">
            <div>
                <i class="fa-solid fa-ranking-star fa-xl top2-icon"></i>
            </div>
            <div>
                <img
                        src="/layout/srcs/icons/user-logo.svg"
                        alt="icon"
                        class="flex-component middle-ranking-profile"
                />
            </div>
            <div class="ranking-profile-info">
                <h6 class="userNickname">-님</h6>
                <p class="userAsset">-원</p>
            </div>
        </div>
        <div class="mini3-box">
            <div>
                <i class="fa-solid fa-ranking-star fa-xl top3-icon"></i>
            </div>
            <div>
                <img
                        src="/layout/srcs/icons/user-logo.svg"
                        alt="icon"
                        class="flex-component middle-ranking-profile"
                />
            </div>
            <div class="ranking-profile-info">
                <h6 class="userNickname">-님</h6>
                <p class="userAsset">-원</p>
            </div>
        </div>
    </div>

    <div class="section">
        <table class="other-rank-table">
            <tbody>
            <tr>
                <td class="rank-number">4</td>
                <td class="other-rank-profile">
                    <img
                            src="/layout/srcs/icons/user-logo.svg"
                            alt="icon"
                            class="flex-component other-ranking-profile"
                    />
                </td>
                <td class="other-rank-nickname">-님</td>
                <td class="other-rank-asset">-원</td>
            </tr>
            <tr>
                <td class="rank-number">5</td>
                <td class="other-rank-profile">
                    <img
                            src="/layout/srcs/icons/user-logo.svg"
                            alt="icon"
                            class="flex-component other-ranking-profile"
                    />
                </td>
                <td class="other-rank-nickname">-님</td>
                <td class="other-rank-asset">-원</td>
            </tr>
            <tr>
                <td class="rank-number">6</td>
                <td class="other-rank-profile">
                    <img
                            src="/layout/srcs/icons/user-logo.svg"
                            alt="icon"
                            class="flex-component other-ranking-profile"
                    />
                </td>
                <td class="other-rank-nickname">-님</td>
                <td class="other-rank-asset">-원</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const getMemberKey = () => {
            const memberKeyElement = document.getElementById('memberKey');
            if (memberKeyElement && memberKeyElement.value) {
                return memberKeyElement.value;
            } else {
                return null;
            }
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('ko-KR').format(amount) + '원';
        };

        const fetchRankingData = async () => {
            const memberKey = getMemberKey();
            try {
                const response = await fetch(
                    memberKey ? `/api/rank/${memberKey}` : '/api/rank/'
                );

                const data = await response.json();
                updateRankingUI(data, !!memberKey);
            } catch (error) {
                console.error('랭킹 데이터 로딩 실패:', error);
            }
        };

        const updateRankingUI = (data, isLoggedIn) => {
            // 사용자 랭킹 섹션 업데이트
            if (isLoggedIn && data.userRank) {
                document.getElementById('userNickname').textContent = data.userRank.userName;
                document.getElementById('userAsset').textContent = formatCurrency(data.userRank.totalAssets);
                document.querySelector('.user-rank-number').textContent = data.userRank.rank + '위';
            }

            // TOP 3 업데이트
            const top3 = data.topRanks.slice(0, 3);
            const top3Elements = document.querySelectorAll('.mini3-box');
            top3.forEach((rank, index) => {
                if (top3Elements[index]) {
                    const nicknameElement = top3Elements[index].querySelector('.userNickname');
                    const assetElement = top3Elements[index].querySelector('.userAsset');

                    nicknameElement.textContent = rank.userName;
                    assetElement.textContent = formatCurrency(rank.totalAssets);
                }
            });

            // 4-6위 테이블 업데이트
            const tbody = document.querySelector('.other-rank-table tbody');
            tbody.innerHTML = ''; // 기존 데이터 초기화

            const remainingRanks = data.topRanks.slice(3);

            // 4부터 6까지의 순위를 항상 표시
            for (let rank = 4; rank <= 10; rank++) {
                const rankData = remainingRanks.find(r => r.rank === rank);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="rank-number">${rank}</td>
                    <td class="other-rank-profile">
                        <img src="/layout/srcs/icons/user-logo.svg" alt="icon" class="flex-component other-ranking-profile"/>
                    </td>
                    <td class="other-rank-nickname">${rankData ? rankData.nickname : '-님'}</td>
                    <td class="other-rank-asset">${rankData ? formatCurrency(rankData.totalAssets) : '-원'}</td>
                `;
                tbody.appendChild(tr);
            }
        };

        fetchRankingData();
    });
</script>
<script th:replace="~{common/sidebar :: sidebar-script}"></script>
<script th:replace="~{common/search :: search-script}"></script>
</body>
</html>