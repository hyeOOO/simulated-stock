<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/css/custom-stockdetail-style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/cb31ad365a.js" crossorigin="anonymous"></script>

    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/indicators/indicators-all.js"></script>
    <script src="https://code.highcharts.com/stock/indicators/ema.js"></script>
</head>
<body class="body">
<div class="sidenav">
    <img src="/layout/srcs/logo.svg" alt="logo" class="logo"/>
    <a href="#" class="menu">HOME</a>
    <a href="#" class="menu">TOP 10</a>
    <a href="#" class="menu">관심 종목</a>
    <a href="#" class="menu">자산 관리</a>
    <div class="flex-container">
        <img src="/layout/srcs/icons/user-logo.svg" alt="icon" class="flex-component"/>
        <a id="userName" class="flex-component" href="javascript:void(0);" th:text="${#authentication.name}"
           onclick="logout()" th:if="${#authorization.expression('isAuthenticated()')}"></a>
        <a class="flex-component" href="/login" th:unless="${#authorization.expression('isAuthenticated()')}">
            Login
        </a>
    </div>
</div>

<div class="main-content">
    <div class="search-group">
        <i class="fa-solid fa-magnifying-glass fa-lg" style="color: #315784;"></i>
        <input type="text" class="search-control" placeholder="검색어를 입력하세요.">
    </div>

    <!-- 종목 상세 정보 표시 부분 -->
    <h5 class="title">&nbsp;</h5>
    <div class="section-group">
        <div class="left-section">
            <div class="section">
                <!-- 종목 상세 정보 표시 부분 -->
                <div class="stock-detail-header">
                    <!-- 왼쪽 영역: 종목명과 코드, 아이콘 -->
                    <div class="stock-header-left">
                        <i class="fas fa-star stock-icon"></i>
                        <div class="stock-info">
                            <h1 class="stock-name">삼성전자</h1>
                            <span class="stock-code">005930</span>
                        </div>
                    </div>

                    <!-- 가운데 영역: 현재가와 등락률 -->
                    <div class="stock-header-center">
                        <div class="price">79,600</div>
                        <div class="price-change">▲ 1,000 | +1.27%</div>
                    </div>

                    <!-- 오른쪽 영역: 세부 정보 (2줄로 배치) -->
                    <div class="stock-header-right">
                        <div class="info-item">
                            <p>전일</p>
                            <p><span>78,600</span></p>
                        </div>
                        <div class="info-item">
                            <p>고가</p>
                            <p><span>80,500</span></p>
                        </div>
                        <div class="info-item">
                            <p>거래량</p>
                            <p><span>22,780,406</span> (67%)</p>
                        </div>
                        <div class="info-item">
                            <p>시가</p>
                            <p><span>79,700</span></p>
                        </div>
                        <div class="info-item">
                            <p>저가</p>
                            <p><span>79,000</span></p>
                        </div>
                        <div class="info-item">
                            <p>거래대금</p>
                            <p><span>1,818,617</span>백만</p>
                        </div>
                    </div>
                </div>

                <div class="stock-chart-container">
                    <div class="chart-tabs">
                        <button class="active">1일</button>
                        <button>1개월</button>
                        <button>3개월</button>
                        <button>1년</button>
                        <button>3년</button>
                    </div>
                    <div class="chart-box">
                        <div id="stock-chart" style="height: 400px; min-width: 800px;"></div>
                    </div>
                </div>
            </div>

            <h5 class="title">투자 정보</h5>
            <div class="section">
                <table class="investment-info-table">
                    <tbody>
                    <tr>
                        <th>상한가</th>
                        <td class="highlight">79,600</td>
                        <th>외국인 비율</th>
                        <td>55.50%(+0.11%)</td>
                    </tr>
                    <tr>
                        <th>하한가</th>
                        <td class="highlight-blue">55,100</td>
                        <th>시가총액</th>
                        <td>4,751,947 억(1위)</td>
                    </tr>
                    <tr>
                        <th>52주 최고</th>
                        <td>86,000</td>
                        <th>EPS/PER</th>
                        <td>2,131/36.9(원/배)</td>
                    </tr>
                    <tr>
                        <th>52주 최저</th>
                        <td>65,800</td>
                        <th>BPS/PBR</th>
                        <td>52,002/1.51(원/배)</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h5 class="title">투자 정보</h5>
            <div class="section">
                <table class="investment-info-table">
                    <tbody>
                    <tr>
                        <th>상한가</th>
                        <td class="highlight">79,600</td>
                        <th>외국인 비율</th>
                        <td>55.50%(+0.11%)</td>
                    </tr>
                    <tr>
                        <th>하한가</th>
                        <td class="highlight-blue">55,100</td>
                        <th>시가총액</th>
                        <td>4,751,947 억(1위)</td>
                    </tr>
                    <tr>
                        <th>52주 최고</th>
                        <td>86,000</td>
                        <th>EPS/PER</th>
                        <td>2,131/36.9(원/배)</td>
                    </tr>
                    <tr>
                        <th>52주 최저</th>
                        <td>65,800</td>
                        <th>BPS/PBR</th>
                        <td>52,002/1.51(원/배)</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h5 class="title">투자 정보</h5>
            <div class="section">
                <table class="investment-info-table">
                    <tbody>
                    <tr>
                        <th>상한가</th>
                        <td class="highlight">79,600</td>
                        <th>외국인 비율</th>
                        <td>55.50%(+0.11%)</td>
                    </tr>
                    <tr>
                        <th>하한가</th>
                        <td class="highlight-blue">55,100</td>
                        <th>시가총액</th>
                        <td>4,751,947 억(1위)</td>
                    </tr>
                    <tr>
                        <th>52주 최고</th>
                        <td>86,000</td>
                        <th>EPS/PER</th>
                        <td>2,131/36.9(원/배)</td>
                    </tr>
                    <tr>
                        <th>52주 최저</th>
                        <td>65,800</td>
                        <th>BPS/PBR</th>
                        <td>52,002/1.51(원/배)</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h5 class="title">투자 정보</h5>
            <div class="section">
                <table class="investment-info-table">
                    <tbody>
                    <tr>
                        <th>상한가</th>
                        <td class="highlight">79,600</td>
                        <th>외국인 비율</th>
                        <td>55.50%(+0.11%)</td>
                    </tr>
                    <tr>
                        <th>하한가</th>
                        <td class="highlight-blue">55,100</td>
                        <th>시가총액</th>
                        <td>4,751,947 억(1위)</td>
                    </tr>
                    <tr>
                        <th>52주 최고</th>
                        <td>86,000</td>
                        <th>EPS/PER</th>
                        <td>2,131/36.9(원/배)</td>
                    </tr>
                    <tr>
                        <th>52주 최저</th>
                        <td>65,800</td>
                        <th>BPS/PBR</th>
                        <td>52,002/1.51(원/배)</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h5 class="title">투자 정보</h5>
            <div class="section">
                <table class="investment-info-table">
                    <tbody>
                    <tr>
                        <th>상한가</th>
                        <td class="highlight">79,600</td>
                        <th>외국인 비율</th>
                        <td>55.50%(+0.11%)</td>
                    </tr>
                    <tr>
                        <th>하한가</th>
                        <td class="highlight-blue">55,100</td>
                        <th>시가총액</th>
                        <td>4,751,947 억(1위)</td>
                    </tr>
                    <tr>
                        <th>52주 최고</th>
                        <td>86,000</td>
                        <th>EPS/PER</th>
                        <td>2,131/36.9(원/배)</td>
                    </tr>
                    <tr>
                        <th>52주 최저</th>
                        <td>65,800</td>
                        <th>BPS/PBR</th>
                        <td>52,002/1.51(원/배)</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h5 class="title">투자 정보</h5>
            <div class="section">
                <table class="investment-info-table">
                    <tbody>
                    <tr>
                        <th>상한가</th>
                        <td class="highlight">79,600</td>
                        <th>외국인 비율</th>
                        <td>55.50%(+0.11%)</td>
                    </tr>
                    <tr>
                        <th>하한가</th>
                        <td class="highlight-blue">55,100</td>
                        <th>시가총액</th>
                        <td>4,751,947 억(1위)</td>
                    </tr>
                    <tr>
                        <th>52주 최고</th>
                        <td>86,000</td>
                        <th>EPS/PER</th>
                        <td>2,131/36.9(원/배)</td>
                    </tr>
                    <tr>
                        <th>52주 최저</th>
                        <td>65,800</td>
                        <th>BPS/PBR</th>
                        <td>52,002/1.51(원/배)</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h5 class="title">투자 정보</h5>
            <div class="section">
                <table class="investment-info-table">
                    <tbody>
                    <tr>
                        <th>상한가</th>
                        <td class="highlight">79,600</td>
                        <th>외국인 비율</th>
                        <td>55.50%(+0.11%)</td>
                    </tr>
                    <tr>
                        <th>하한가</th>
                        <td class="highlight-blue">55,100</td>
                        <th>시가총액</th>
                        <td>4,751,947 억(1위)</td>
                    </tr>
                    <tr>
                        <th>52주 최고</th>
                        <td>86,000</td>
                        <th>EPS/PER</th>
                        <td>2,131/36.9(원/배)</td>
                    </tr>
                    <tr>
                        <th>52주 최저</th>
                        <td>65,800</td>
                        <th>BPS/PBR</th>
                        <td>52,002/1.51(원/배)</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h5 class="title">투자 정보</h5>
            <div class="section">
                <table class="investment-info-table">
                    <tbody>
                    <tr>
                        <th>상한가</th>
                        <td class="highlight">79,600</td>
                        <th>외국인 비율</th>
                        <td>55.50%(+0.11%)</td>
                    </tr>
                    <tr>
                        <th>하한가</th>
                        <td class="highlight-blue">55,100</td>
                        <th>시가총액</th>
                        <td>4,751,947 억(1위)</td>
                    </tr>
                    <tr>
                        <th>52주 최고</th>
                        <td>86,000</td>
                        <th>EPS/PER</th>
                        <td>2,131/36.9(원/배)</td>
                    </tr>
                    <tr>
                        <th>52주 최저</th>
                        <td>65,800</td>
                        <th>BPS/PBR</th>
                        <td>52,002/1.51(원/배)</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="right-section right-section-sticky">
            <div class="section user-asset">
                <div class="flex-text-group">
                    <p>총 자산</p>
                    <p class="total-asset">10,962,194 원</p>
                </div>
                <div class="flex-text-group">
                    <p>가용 자산</p>
                    <p class="available-asset">2,264,568 원</p>
                </div>
            </div>

            <div class="section order-form">
                <h6>주문 입력</h6>
                <div class="btn-group">
                    <button id="buy-btn" class="active">매수</button>
                    <button id="sell-btn">매도</button>
                </div>
                <form>
                    <!-- 주문 구분 -->
                    <div class="radio-group">
                        <label>주문 구분</label>
                        <input type="radio" id="fixed-price" name="priceType" checked>
                        <label for="fixed-price">지정가</label>
                        <input type="radio" id="market-price" name="priceType">
                        <label for="market-price">시장가</label>
                    </div>

                    <!-- 주문 수량 -->
                    <div class="form-group">
                        <label for="quantity">주문 수량</label>
                        <input type="text" id="quantity" placeholder="주">
                    </div>

                    <!-- 매수 가격 -->
                    <div class="form-group">
                        <label for="price">매수 가격</label>
                        <input type="text" id="price" placeholder="원">
                    </div>

                    <!-- 주문 총액 -->
                    <div class="form-group">
                        <label for="total">주문 총액</label>
                        <input type="text" id="total" placeholder="원">
                    </div>

                    <div class="submit-group">
                        <button type="button" class="reserve-action">예약</button>
                        <button type="submit" class="buy-action">매수하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        let accessToken = getCookie("Authorization")
        console.log(accessToken);

        if(accessToken!=null){
            axios.get('/members/info', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                const memberInfo = response.data;
                document.getElementById('userName').textContent = memberInfo.name;
            })
            .catch(error => {
                console.error('Failed to fetch member info:', error);
                if (error.response && error.response.status === 401) {
                    alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                    window.location.href = '/login';
                } else {
                    alert('사용자 정보를 가져오는데 실패했습니다.');
                }
            });
        }
    });
    function logout() {
        axios.get('/auth/logout')
            .then(() => {
                window.location.href = '/login';
            })
            .catch(error => {
                console.error('Logout failed:', error);
                // 오류 발생 시 사용자에게 알림
                alert('로그아웃 중 오류가 발생했습니다. 다시 시도해 주세요.');
            });
    }
    function getCookie(cookieName) {
        let name = cookieName + "=";
        let decodedCookie = decodeURIComponent(document.cookie); // 쿠키 값이 인코딩되어 있을 수 있으므로 디코딩
        let cookieArray = decodedCookie.split(';'); // 각 쿠키는 세미콜론으로 구분됨

        for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i].trim(); // 공백 제거

            // 쿠키 이름으로 시작하는지 확인
            if (cookie.indexOf(name) === 0) {
                return cookie.substring(name.length, cookie.length); // 쿠키 값 반환
            }
        }
        return ""; // 해당 이름의 쿠키가 없으면 빈 문자열 반환
    }

    document.addEventListener('DOMContentLoaded', function () {
        let stockChart;

        // 샘플 주가 데이터 (시가, 고가, 저가, 종가, 거래량)
        const sampleData = [
            [Date.UTC(2023, 2, 18), 78000, 79000, 77000, 78500, 2000000],
            [Date.UTC(2023, 2, 19), 78500, 80000, 78000, 79500, 2100000],
            [Date.UTC(2023, 2, 20), 79500, 80500, 78500, 80000, 2200000],
            // 더 많은 샘플 데이터 추가
        ];

        function createChart(data) {
            stockChart = Highcharts.stockChart('stock-chart', {
                rangeSelector: {
                    selected: 1, // 초기 선택된 범위 (예: 1개월)
                },
                title: {
                    text: 'Sample Stock Price with Volume',
                },
                yAxis: [
                    {
                        labels: {
                            align: 'right',
                            x: -3,
                        },
                        title: {
                            text: '주가',
                        },
                        height: '60%',
                        lineWidth: 2,
                        resize: {
                            enabled: true,
                        },
                    },
                    {
                        labels: {
                            align: 'right',
                            x: -3,
                        },
                        title: {
                            text: '거래량',
                        },
                        top: '65%',
                        height: '35%',
                        offset: 0,
                        lineWidth: 2,
                    },
                ],

                tooltip: {
                    split: true,
                },

                series: [
                    {
                        type: 'candlestick',
                        name: '주가',
                        data: data.map((item) => [item[0], item[1], item[2], item[3], item[4]]),
                        dataGrouping: {
                            units: [
                                ['day', [1]],
                                ['week', [1]],
                                ['month', [1, 2, 3, 4, 6]],
                            ],
                        },
                    },
                    {
                        type: 'column',
                        name: '거래량',
                        data: data.map((item) => [item[0], item[5]]),
                        yAxis: 1,
                        dataGrouping: {
                            units: [
                                ['day', [1]],
                                ['week', [1]],
                                ['month', [1, 2, 3, 4, 6]],
                            ],
                        },
                    },
                    {
                        type: 'sma',
                        linkedTo: '주가',
                        zIndex: 1,
                        marker: {
                            enabled: false,
                        },
                        params: {
                            period: 14, // 이동평균의 기간 설정
                        },
                    },
                ],
            });
        }

        // 초기 차트 생성
        createChart(sampleData);

        // 차트 기간 변경 이벤트 처리 함수
        function changeRange(range) {
            let newData;

            // 기간에 따라 샘플 데이터 설정 (데이터는 실제 API 연동 시 동적으로 설정)
            switch (range) {
                case '1d':
                    newData = sampleData.slice(-1); // 마지막 1일 데이터
                    break;
                case '1m':
                    newData = sampleData.slice(-30); // 마지막 1개월 데이터 (대략 30일치)
                    break;
                case '3m':
                    newData = sampleData.slice(-90); // 마지막 3개월 데이터
                    break;
                case '1y':
                    newData = sampleData.slice(-250); // 마지막 1년 데이터 (대략 250일치)
                    break;
                case '3y':
                    newData = sampleData; // 전체 데이터 사용 (3년치)
                    break;
                default:
                    newData = sampleData;
            }

            // 차트 업데이트
            stockChart.series[0].setData(newData.map((item) => [item[0], item[1], item[2], item[3], item[4]])); // 주가 데이터
            stockChart.series[1].setData(newData.map((item) => [item[0], item[5]])); // 거래량 데이터
        }

        // 버튼 클릭 이벤트 바인딩
        document.querySelectorAll('.chart-tab').forEach((button) => {
            button.addEventListener('click', function () {
                document.querySelectorAll('.chart-tab').forEach((btn) => btn.classList.remove('active'));
                button.classList.add('active');
                changeRange(button.innerText); // 버튼의 텍스트에 맞게 기간 변경
            });
        });
    });
</script>